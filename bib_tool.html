<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Bibæ–‡çŒ®ç®¡ç†åŠ©æ‰‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        header {
            background: #2d3e50;
            color: #fff;
            padding: 1em;
        }

        nav {
            background: #f5f5f5;
            padding: 0.5em;
        }

        nav button {
            margin-right: 1em;
        }

        .container {
            display: flex;
            padding: 1em;
        }

        .editor,
        .viewer {
            flex: 1;
            margin: 0 1em;
        }

        .hidden {
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 0.5em;
        }

        th {
            background: #eee;
        }

        .actions button {
            margin-right: 0.5em;
        }
    </style>
</head>

<body>
    <header>
        <h1>Bibæ–‡çŒ®ç®¡ç†åŠ©æ‰‹</h1>
    </header>
    <nav>
        <button id="editViewBtn">ç¼–è¾‘è§†å›¾</button>
        <button id="useViewBtn">ä½¿ç”¨è§†å›¾</button>
    </nav>
    <div class="container">
        <!-- ç¼–è¾‘è§†å›¾ -->
        <div class="editor" id="editorView">
            <h2>ç¼–è¾‘è§†å›¾</h2>
            <div>
                <label>å¯¼å…¥jsonlæ–‡ä»¶: <input type="file" id="importJsonl"></label>
                <button id="exportJsonl">å¯¼å‡ºjsonl</button>
            </div>
            <form id="bibForm" style="margin-top: 1em;">
                <div style="margin-bottom: 1em;">
                    <label style="display:inline-block;width:80px;">æ–‡ç« æ ‡é¢˜:</label>
                    <input type="text" id="title" readonly style="width: 350px; background: #f5f5f5;">
                </div>
                <div style="margin-bottom: 1em; display: flex; align-items: flex-start;">
                    <label style="width:80px; flex-shrink:0; margin-right:0;">Bibå†…å®¹:</label>
                    <textarea id="bibContent" rows="4"
                        style="width: 350px; height: 90px; box-sizing: border-box;"></textarea>
                </div>
                <div style="margin-bottom: 1em;">
                    <label style="display:inline-block;width:80px;">ç¼©å†™:</label>
                    <input type="text" id="bibKey" readonly style="width: 350px; background: #f5f5f5;">
                </div>
                <div style="margin-bottom: 1em;">
                    <label style="display:inline-block;width:80px;">ç±»åˆ«æ ‡ç­¾:</label>
                    <input type="text" id="tags" style="width: 350px;">
                </div>
                <div style="margin-bottom: 1em;">
                    <label style="display:inline-block;width:80px;">å¤‡æ³¨:</label>
                    <input type="text" id="note" style="width: 350px;">
                </div>
                <button type="submit">æ·»åŠ /æ›´æ–°</button>
            </form>
            <div>
                <h3>å·²æ·»åŠ æ–‡çŒ®</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ç¼©å†™</th>
                            <th>æ ‡é¢˜</th>
                            <th>ç±»åˆ«æ ‡ç­¾</th>
                            <th>å¤‡æ³¨</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="bibList">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- ä½¿ç”¨è§†å›¾ -->
        <div class="viewer hidden" id="useView">
            <h2>ä½¿ç”¨è§†å›¾</h2>
            <div>
                <button id="copySelectedBib">å¤åˆ¶æ‰€é€‰Bib</button>
                <button id="copySelectedKeys">å¤åˆ¶æ‰€é€‰ç¼©å†™</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>ç¼©å†™</th>
                        <th>æ ‡é¢˜</th>
                        <th>ç±»åˆ«æ ‡ç­¾</th>
                        <th>å¤‡æ³¨</th>
                        <th>Bibå†…å®¹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="useBibList">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        let bibData = [];

        // è‡ªåŠ¨æå–ç¼©å†™å’Œæ ‡é¢˜
        document.getElementById('bibContent').addEventListener('input', function () {
            const bib = this.value;
            // æå–ç¼©å†™
            const keyMatch = bib.match(/@\w+\{([^,]+),/);
            if (keyMatch) {
                document.getElementById('bibKey').value = keyMatch[1];
            }
            // æå–æ ‡é¢˜
            const titleMatch = bib.match(/title\s*=\s*[{"]([^"}]+)[}"]/i);
            if (titleMatch) {
                document.getElementById('title').value = titleMatch[1];
            }
        });

        // æ·»åŠ /æ›´æ–°æ–‡çŒ®
        document.getElementById('bibForm').onsubmit = function (e) {
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const bibContent = document.getElementById('bibContent').value.trim();
            const bibKey = document.getElementById('bibKey').value.trim();
            const tags = document.getElementById('tags').value.trim();
            const note = document.getElementById('note').value.trim();

            if (!bibKey || !bibContent) {
                alert('è¯·å¡«å†™Bibå†…å®¹å’Œç¼©å†™');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œå­˜åœ¨åˆ™æ›´æ–°
            const idx = bibData.findIndex(item => item.bibKey === bibKey);
            const entry = { title, bibContent, bibKey, tags, note };
            if (idx >= 0) {
                bibData[idx] = entry;
            } else {
                bibData.push(entry);
            }
            renderBibList();
            this.reset();
        };

        // æ¸²æŸ“ç¼–è¾‘è§†å›¾åˆ—è¡¨
        function renderBibList() {
            const tbody = document.getElementById('bibList');
            tbody.innerHTML = '';
            bibData.forEach((item, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${item.bibKey}</td>
            <td>${item.title}</td>
            <td>${item.tags}</td>
            <td>${item.note}</td>
            <td class="actions">
                <button onclick="editBib(${i})">ç¼–è¾‘</button>
                <button onclick="deleteBib(${i})">åˆ é™¤</button>
            </td>
        `;
                tbody.appendChild(tr);
            });
            renderUseList();
        }

        // ç¼–è¾‘
        window.editBib = function (i) {
            const item = bibData[i];
            document.getElementById('title').value = item.title;
            document.getElementById('bibContent').value = item.bibContent;
            document.getElementById('bibKey').value = item.bibKey;
            document.getElementById('tags').value = item.tags;
            document.getElementById('note').value = item.note;
        };

        // åˆ é™¤
        window.deleteBib = function (i) {
            if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                bibData.splice(i, 1);
                renderBibList();
            }
        };

        // å¯¼å…¥jsonl
        document.getElementById('importJsonl').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function () {
                const lines = reader.result.split('\n').filter(Boolean);
                bibData = lines.map(line => {
                    try { return JSON.parse(line); } catch { return null; }
                }).filter(Boolean);
                renderBibList();
            };
            reader.readAsText(file, 'utf-8');
        });

        // å¯¼å‡ºjsonl
        document.getElementById('exportJsonl').onclick = function () {
            const content = bibData.map(item => JSON.stringify(item)).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'bib_data.jsonl';
            a.click();
        };

        // æ¸²æŸ“ä½¿ç”¨è§†å›¾åˆ—è¡¨
        function renderUseList() {
            const tbody = document.getElementById('useBibList');
            tbody.innerHTML = '';
            bibData.forEach((item, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td><input type="checkbox" class="selectBib" data-idx="${i}"></td>
            <td>
                <button onclick="copyKey('${item.bibKey}')" title="å¤åˆ¶ç¼©å†™" style="margin-left:4px;">ğŸ“‹</button>
                ${item.bibKey}
            </td>
            <td>${item.title}</td>
            <td>${item.tags}</td>
            <td>${item.note}</td>
            <td><pre style="white-space:pre-wrap;">${item.bibContent}</pre></td>
            <td></td>
        `;
                tbody.appendChild(tr);
            });
        }

        // å¤åˆ¶ç¼©å†™
        window.copyKey = function (key) {
            navigator.clipboard.writeText(key);
            alert('å·²å¤åˆ¶ç¼©å†™: ' + key);
        };

        // å¤åˆ¶æ‰€é€‰Bib
        document.getElementById('copySelectedBib').onclick = function () {
            const checkboxes = document.querySelectorAll('.selectBib:checked');
            const bibs = Array.from(checkboxes).map(cb => bibData[cb.dataset.idx].bibContent);
            if (bibs.length) {
                navigator.clipboard.writeText(bibs.join('\n\n'));
                alert('å·²å¤åˆ¶æ‰€é€‰Bib');
            }
        };

        // å¤åˆ¶æ‰€é€‰ç¼©å†™
        document.getElementById('copySelectedKeys').onclick = function () {
            const checkboxes = document.querySelectorAll('.selectBib:checked');
            const keys = Array.from(checkboxes).map(cb => bibData[cb.dataset.idx].bibKey);
            if (keys.length) {
                navigator.clipboard.writeText(keys.join(', '));
                alert('å·²å¤åˆ¶æ‰€é€‰ç¼©å†™');
            }
        };

        // å…¨é€‰
        document.getElementById('selectAll').onclick = function () {
            const checked = this.checked;
            document.querySelectorAll('.selectBib').forEach(cb => cb.checked = checked);
        };

        // è§†å›¾åˆ‡æ¢é€»è¾‘
        document.getElementById('editViewBtn').onclick = function () {
            document.getElementById('editorView').classList.remove('hidden');
            document.getElementById('useView').classList.add('hidden');
        };
        document.getElementById('useViewBtn').onclick = function () {
            document.getElementById('editorView').classList.add('hidden');
            document.getElementById('useView').classList.remove('hidden');
        };
    </script>
</body>

</html>